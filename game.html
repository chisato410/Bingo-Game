<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ãƒ“ãƒ³ã‚´ãƒã‚·ãƒ¼ãƒ³</title>
    <style>
      .wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }

      button:disabled {
        opacity: 0.5;
        pointer-events: none;
      }

      /* ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰å…¨ä½“ã‚’5x5ã®ã‚°ãƒªãƒƒãƒ‰ã§è¡¨ç¤º */
      .bingo-card {
        display: grid;
        grid-template-columns: repeat(5, 40px);
        grid-template-rows: repeat(5, 40px);
        gap: 5px;
      }

      /* ãƒ“ãƒ³ã‚´ã®ãƒã‚¹ã®è¦‹ãŸç›® */
      .bingo-card div {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #eee;
        border: 1px solid #ccc;
        font-weight: bold;
      }

      /* çœŸã‚“ä¸­ã®FREEãƒã‚¹ */
      .bingo-card .free {
        background-color: gold;
      }

      /* æŠ½é¸ã•ã‚ŒãŸç•ªå·ã«è©²å½“ã™ã‚‹ãƒã‚¹ */
      .bingo-card .hit {
        background-color: tomato;
        color: #fff;
      }

      /* ãƒ“ãƒ³ã‚´æˆç«‹ã—ãŸãƒã‚¹ã«ä»˜ã‘ã‚‹å…‰ã‚‹åŠ¹æœ */
      .bingo-card .bingo-line {
        animation: blink 0.6s infinite alternate;
      }

      /* ç‚¹æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
      @keyframes blink {
        0% {
          background-color: #ff6347;
        }
        100% {
          background-color: #ff0;
          color: #000;
        }
      }

      /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ */
      .message {
        position: absolute;
        top: 10%;
        left: 50%;
        transform: translateX(-50%);
        font-size: 3rem;
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 10;
      }

      /* BINGO! ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¼”å‡º */
      .bingo-msg {
        color: #32cd32;
        text-shadow: 0 0 10px #32cd32;
        animation: popup 0.5s ease-out forwards;
      }

      /* ãƒªãƒ¼ãƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¼”å‡º */
      .reach-msg {
        color: #ffd700;
        text-shadow: 0 0 10px #ffd700;
        animation: popup 0.5s ease-out forwards;
      }

      /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
      @keyframes popup {
        0% {
          opacity: 0;
          transform: translate(-50%, -30%) scale(0.8);
        }
        100% {
          opacity: 1;
          transform: translate(-50%, 0%) scale(1);
        }
      }
    </style>
  </head>

  <body>
    <div class="wrapper">
      <h1>BINGO GAME</h1>
      <!-- å„ç¨®ãƒœã‚¿ãƒ³ -->
      <div class="btn">
        <button class="start">START</button>
        <button class="stop">STOP</button>
        <button class="reset">RESET</button>
        <button class="generate">NEW GAME</button>
      </div>
      <!-- æŠ½é¸çµæœã¨å±¥æ­´ -->
      <p class="result">0</p>
      <p class="history"></p>
      <!-- ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰æœ¬ä½“ -->
      <div class="bingo-card" id="bingoCard"></div>
      <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
      <div id="message" class="message"></div>
    </div>

    <script>
      // ãƒœã‚¿ãƒ³è¦ç´ å–å¾—
      const startBtn = document.querySelector(".start");
      const stopBtn = document.querySelector(".stop");
      const resetBtn = document.querySelector(".reset");
      const generateBtn = document.querySelector(".generate");

      // è¡¨ç¤ºã‚¨ãƒªã‚¢è¦ç´ å–å¾—
      const resultEl = document.querySelector(".result");
      const historyEl = document.querySelector(".history");
      const bingoCardEl = document.getElementById("bingoCard");
      const messageEl = document.getElementById("message");

      // æ•°å­—é…åˆ—ï¼ˆ1ã€œ75ï¼‰
      const num = Array.from({ length: 75 }, (_, i) => i + 1);

      // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†ç”¨å¤‰æ•°
      let randomNum = [];
      let historyNum = [];
      let currentIndex = 0;
      let timeId = null;
      let isRunning = false;
      let hasBingo = false; // âœ… è¿½åŠ ï¼šãƒ“ãƒ³ã‚´æ¸ˆã¿ãƒ•ãƒ©ã‚°

      // é…åˆ—ã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢æ•°ï¼ˆFisherâ€“Yatesï¼‰
      const shuffle = (array) => {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      };

      // ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
      const resetState = () => {
        isRunning = false;
        hasBingo = false; // âœ… ãƒ“ãƒ³ã‚´ãƒ•ãƒ©ã‚°åˆæœŸåŒ–
        clearInterval(timeId);
        currentIndex = 0;
        randomNum = shuffle([...num]);
        historyNum = [];
        resultEl.textContent = 0;
        historyEl.textContent = "";
        messageEl.textContent = "";
        messageEl.className = "message";

        // å…¨ãƒã‚¹åˆæœŸåŒ–
        const cells = document.querySelectorAll("#bingoCard div");
        cells.forEach((cell) => {
          cell.classList.remove("hit", "bingo-line");
        });
      };

      // æ•°å­—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§è¡¨ç¤ºã™ã‚‹
      const startRandom = () => {
        if (hasBingo) return; // âœ… ãƒ“ãƒ³ã‚´ãªã‚‰é–‹å§‹ä¸å¯
        clearInterval(timeId);
        timeId = setInterval(() => {
          currentIndex = (currentIndex + 1) % randomNum.length;
          resultEl.textContent = randomNum[currentIndex];
        }, 30);
        setGameButtonsEnabled(true);
      };

      const setGameButtonsEnabled = (enabled) => {
        startBtn.disabled = !enabled;
        stopBtn.disabled = !enabled;
        resetBtn.disabled = !enabled;
      };

      // STOPå‡¦ç†ï¼ˆç•ªå·ç¢ºå®šï¼†åˆ¤å®šï¼‰
      const stopRandom = () => {
        if (hasBingo || isRunning || randomNum.length === 0) return; // âœ… ãƒ“ãƒ³ã‚´æ¸ˆãƒ»å®Ÿè¡Œä¸­ãƒ»çµ‚äº†ãªã‚‰ç„¡åŠ¹

        isRunning = false;
        clearInterval(timeId);

        const [selected] = randomNum.splice(currentIndex, 1);
        if (selected !== undefined) {
          historyNum.push(selected);
        }

        resultEl.textContent = selected;
        historyEl.textContent = historyNum.join(", ");
        currentIndex = 0;

        const cells = document.querySelectorAll("#bingoCard div");
        cells.forEach((cell) => {
          if (cell.dataset.value == selected) {
            cell.classList.add("hit");
          }
        });

        const status = checkBingoStatus();
        if (status.bingoLines.length > 0) {
          hasBingo = true; // âœ… ãƒ“ãƒ³ã‚´çŠ¶æ…‹ã«ã™ã‚‹
          status.bingoLines.forEach((line) => {
            line.forEach((i) => {
              cells[i].classList.add("bingo-line");
            });
          });
          showMessage("ğŸ‰ BINGO! ğŸ‰", "bingo-msg");
          setGameButtonsEnabled(false);
        } else if (status.reachCount > 0) {
          showMessage("âš¡ ãƒªãƒ¼ãƒï¼", "reach-msg");
        }
      };

      // ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã®ç”Ÿæˆ
      const generateBingoCard = () => {
        const numbers = shuffle([...num]);
        const card = numbers.slice(0, 24);
        card.splice(12, 0, "FREE");

        bingoCardEl.innerHTML = "";
        card.forEach((value) => {
          const cell = document.createElement("div");
          cell.textContent = value;
          if (value === "FREE") {
            cell.classList.add("free", "hit");
          } else {
            cell.dataset.value = value;
          }
          bingoCardEl.appendChild(cell);
        });
      };

      // ãƒ“ãƒ³ã‚´ãƒ»ãƒªãƒ¼ãƒåˆ¤å®š
      const checkBingoStatus = () => {
        const cells = document.querySelectorAll("#bingoCard div");
        const getIndex = (row, col) => row * 5 + col;
        const lines = [];

        for (let row = 0; row < 5; row++) {
          lines.push(Array.from({ length: 5 }, (_, i) => getIndex(row, i)));
        }
        for (let col = 0; col < 5; col++) {
          lines.push(Array.from({ length: 5 }, (_, i) => getIndex(i, col)));
        }
        lines.push([0, 6, 12, 18, 24]);
        lines.push([4, 8, 12, 16, 20]);

        let bingoLines = [];
        let reachCount = 0;

        lines.forEach((line) => {
          const hitCount = line.filter((i) =>
            cells[i].classList.contains("hit")
          ).length;

          if (hitCount === 5) {
            bingoLines.push(line);
          } else if (hitCount === 4) {
            reachCount++;
          }
        });

        return { bingoLines, reachCount };
      };

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      const showMessage = (text, className) => {
        messageEl.textContent = text;
        messageEl.className = "message " + className;
        setTimeout(() => {
          messageEl.textContent = "";
          messageEl.className = "message";
        }, 2000);
      };

      // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
      startBtn.addEventListener("click", startRandom);
      stopBtn.addEventListener("click", stopRandom);
      resetBtn.addEventListener("click", resetState);
      generateBtn.addEventListener("click", () => {
        generateBingoCard();
        resetState();
      });

      // åˆæœŸåŒ–å‡¦ç†
      generateBingoCard();
      resetState();
    </script>
  </body>
</html>
